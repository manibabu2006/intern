<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard | RentHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --card:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.15);
  --primary:#38bdf8;
  --success:#22c55e;
  --danger:#ef4444;
  --pending:#facc15;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  display:flex;
}

/* ===== SIDEBAR ===== */
aside{
  width:240px;
  background:var(--panel);
  padding:25px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

aside h2{margin:0}
aside p{opacity:.85}

aside button{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--danger);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* ===== MAIN ===== */
main{
  flex:1;
  padding:25px;
}

.section{margin-bottom:30px}
.section h3{margin-bottom:14px}

/* ===== SELECT ===== */
.location-select{
  width:100%;
  padding:12px 16px;
  border-radius:14px;
  border:none;
  background:#020617;
  color:#fff;
  font-size:15px;
}

/* ===== GRIDS ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}

/* ===== CARDS ===== */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  text-align:center;
  transition:.25s;
}
.card:hover{transform:translateY(-4px)}

button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.primary{background:var(--primary);color:#000}
.danger{background:var(--danger);color:#fff}

.Pending{color:var(--pending)}
.Accepted{color:var(--success)}
.Rejected{color:var(--danger)}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  justify-content:center;
  align-items:center;
}

.modal-content{
  background:var(--panel);
  padding:25px;
  border-radius:18px;
  width:90%;
  max-width:420px;
  border:1px solid var(--border);
}

.modal-content input{
  width:100%;
  padding:10px;
  margin:12px 0;
  border-radius:10px;
  border:none;
  background:#020617;
  color:#fff;
}

.modal-content label{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  margin-bottom:10px;
}

.modal-content input[type="checkbox"]{
  appearance:none;
  width:20px;
  height:20px;
  border-radius:5px;
  border:2px solid var(--primary);
  position:relative;
}

.modal-content input[type="checkbox"]:checked{
  background:var(--primary);
}
.modal-content input[type="checkbox"]:checked::after{
  content:'‚úî';
  color:#000;
  position:absolute;
  top:-1px;
  left:3px;
  font-size:14px;
}
</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->
<aside>
  <h2>üöÄ RentHub</h2>
  <p>Customer Panel</p>
  <p><b id="customerName"></b></p>
  <button onclick="logout()">Logout</button>
</aside>

<!-- ===== MAIN ===== -->
<main>

  <div class="section">
    <h3>Select Location</h3>
    <select id="location" class="location-select">
      <option>Loading...</option>
    </select>
  </div>

  <div class="section">
    <h3>Select Category</h3>
    <div class="grid">
      <div class="card" onclick="loadItems('Electronics')">üíª Electronics</div>
      <div class="card" onclick="loadItems('Bike')">üèç Bikes</div>
      <div class="card" onclick="loadItems('Car')">üöó Cars</div>
      <div class="card" onclick="loadItems('Tent')">üèï Tents</div>
      <div class="card" onclick="loadItems('Appliance')">üè† Appliances</div>
    </div>
  </div>

  <div class="section">
    <h3>Available Items</h3>
    <div class="grid" id="items"></div>
  </div>

  <div class="section">
    <h3>Your Booking History</h3>
    <div class="grid" id="history"></div>
  </div>

</main>

<!-- ===== BOOKING MODAL ===== -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>Confirm Booking</h3>
    <label>
      <input type="checkbox" id="terms">
      Accept terms and conditions
    </label>
    <input type="number" id="duration" placeholder="Days" min="1">
    <button id="confirmBtn" class="primary" disabled>Book</button>
    <button class="danger" onclick="closeBooking()">Cancel</button>
  </div>
</div>

<script>
const customerId = localStorage.getItem("customer_id");
if(!customerId){ 
    alert("Login required"); 
    location.href="index.html"; 
}

const customerName = document.getElementById("customerName");
const locationSelect = document.getElementById("location");
const items = document.getElementById("items");
const history = document.getElementById("history");
customerName.innerText = localStorage.getItem("name") || "Customer";

function logout() { 
    localStorage.clear(); 
    location.href="index.html"; 
}

let selectedItem = null;
const bookingModal = document.getElementById("bookingModal");
const confirmBtn = document.getElementById("confirmBtn");
const terms = document.getElementById("terms");
const duration = document.getElementById("duration");

// Enable confirm button only if terms accepted and duration > 0
terms.onchange = duration.oninput = () => { 
    confirmBtn.disabled = !terms.checked || !duration.value || duration.value <= 0; 
};

function openBooking(id) { 
    selectedItem = id; 
    bookingModal.style.display = "flex"; 
    terms.checked = false; 
    duration.value = ""; 
    confirmBtn.disabled = true; 
}
function closeBooking() { bookingModal.style.display = "none"; }

confirmBtn.onclick = async () => {
    try {
        const res = await fetch("/api/create-request", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ 
                action: "createBooking", 
                item_id: selectedItem, 
                customer_id: customerId, 
                rental_duration: duration.value 
            })
        });
        const d = await res.json();
        if(d.success) { 
            alert("‚úÖ Booking sent"); 
            closeBooking(); 
            loadHistory(); 
        } else {
            alert(d.message || "Failed");
        }
    } catch {
        alert("Server error");
    }
};

// ========== LOAD LOCATIONS ==========
async function loadLocations() {
    locationSelect.disabled = true;
    locationSelect.innerHTML = `<option>Loading locations...</option>`;
    
    try {
        const res = await fetch("/api/items");
        const d = await res.json();

        if (!d.success || !d.locations?.length) {
            locationSelect.innerHTML = `<option>No locations found</option>`;
            return;
        }

        locationSelect.innerHTML = `<option value="">Select location</option>`;
        d.locations.forEach(l => {
            locationSelect.innerHTML += `<option value="${l}">${l}</option>`;
        });
        locationSelect.disabled = false;

    } catch {
        locationSelect.innerHTML = `<option>Error loading locations</option>`;
        locationSelect.disabled = false;
    }
}

// ========== LOAD ITEMS BY CATEGORY ==========
async function loadItems(category) {
    if(!locationSelect.value){ 
        alert("Select location first"); 
        return; 
    }
    items.innerHTML = `<p>Loading items...</p>`;

    try {
        const res = await fetch("/api/items", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ action: "getItems", category, location: locationSelect.value })
        });
        const d = await res.json();

        if(!d.success || !d.items?.length) {
            items.innerHTML = "<p>No items found</p>";
            return;
        }

        items.innerHTML = "";
        d.items.forEach(i => {
            items.innerHTML += `
                <div class="card">
                    <h4>${i.item_name}</h4>
                    <p>‚Çπ${i.price_per_day}/day</p>
                    <p>${i.shop_name}</p>
                    <button class="primary" onclick="openBooking(${i.item_id})">Book</button>
                </div>
            `;
        });

    } catch {
        items.innerHTML = "<p>Error loading items</p>";
    }
}

// ========== LOAD BOOKING HISTORY ==========
async function loadHistory() {
    history.innerHTML = `<p>Loading history...</p>`;
    try {
        const res = await fetch(`/api/create-request?customer_id=${customerId}`);
        const d = await res.json();

        if(!d.success || !d.history?.length) {
            history.innerHTML = "<p>No bookings yet</p>";
            return;
        }

        history.innerHTML = "";
        d.history.forEach(b => {
            history.innerHTML += `
                <div class="card">
                    <b>${b.item_name}</b><br>
                    ${b.shop_name}<br>
                    Days: ${b.rental_duration}<br>
                    Status: <span class="${b.status}">${b.status}</span>
                </div>
            `;
        });
    } catch {
        history.innerHTML = "<p>Error loading history</p>";
    }
}

// Load locations and history on page load
window.onload = () => { 
    loadLocations(); 
    loadHistory(); 
};
</script>

</body>
</html>
