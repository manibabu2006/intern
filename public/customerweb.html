<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard | RentHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --card:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.15);
  --primary:#38bdf8;
  --success:#22c55e;
  --danger:#ef4444;
  --pending:#facc15;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  display:flex;
}

/* ===== SIDEBAR ===== */
aside{
  width:240px;
  background:var(--panel);
  padding:25px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

aside h2{margin:0}
aside p{opacity:.85}

aside button{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--danger);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* ===== MAIN ===== */
main{
  flex:1;
  padding:25px;
}

.section{margin-bottom:30px}
.section h3{margin-bottom:14px}

/* ===== SELECT ===== */
.location-select{
  width:100%;
  padding:12px 16px;
  border-radius:14px;
  border:none;
  background:#020617;
  color:#fff;
  font-size:15px;
}

/* ===== GRIDS ===== */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}

/* ===== CARDS ===== */
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  text-align:center;
  transition:.25s;
}
.card:hover{transform:translateY(-4px)}

button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.primary{background:var(--primary);color:#000}
.danger{background:var(--danger);color:#fff}

.Pending{color:var(--pending)}
.Accepted{color:var(--success)}
.Rejected{color:var(--danger)}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.75);
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.modal-content{
  background:var(--panel);
  padding:25px;
  border-radius:18px;
  width:90%;
  max-width:420px;
  border:1px solid var(--border);
}

.modal-content h3{
  text-align:center;
  margin-top:0;
}

.modal-content input,
.modal-content textarea{
  width:100%;
  padding:10px;
  margin:10px 0;
  border-radius:10px;
  border:none;
  background:#020617;
  color:#fff;
}

.modal-content textarea{resize:none}

.modal-content label{
  display:flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  margin:8px 0;
  font-size:14px;
}

.modal-content ul{
  padding-left:18px;
  font-size:13px;
  opacity:.85;
}

.modal-content input[type="checkbox"]{
  appearance:none;
  width:18px;
  height:18px;
  border-radius:5px;
  border:2px solid var(--primary);
}

.modal-content input[type="checkbox"]:checked{
  background:var(--primary);
}
.modal-content input[type="checkbox"]:checked::after{
  content:"‚úî";
  color:#000;
  font-size:12px;
  position:relative;
  left:3px;
  top:-1px;
}
</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->
<aside>
  <h2>üöÄ RentHub</h2>
  <p>Customer Panel</p>
  <p><b id="customerName"></b></p>
  <button onclick="logout()">Logout</button>
</aside>

<!-- ===== MAIN ===== -->
<main>

  <div class="section">
    <h3>Select Location</h3>
    <select id="location" class="location-select">
      <option>Loading...</option>
    </select>
  </div>

  <div class="section">
    <h3>Select Category</h3>
    <div class="grid">
      <div class="card" onclick="loadItems('Electronics')">üíª Electronics</div>
      <div class="card" onclick="loadItems('Bike')">üèç Bikes</div>
      <div class="card" onclick="loadItems('Car')">üöó Cars</div>
      <div class="card" onclick="loadItems('Tent')">üèï Tents</div>
      <div class="card" onclick="loadItems('Appliance')">üè† Appliances</div>
    </div>
  </div>

  <div class="section">
    <h3>Available Items</h3>
    <div class="grid" id="items"></div>
  </div>

  <div class="section">
    <h3>Your Booking History</h3>
    <div class="grid" id="history"></div>
  </div>

</main>

<!-- ===== BOOKING MODAL ===== -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>üìù Complete Booking</h3>

    <input type="text" id="custName" placeholder="Full Name">
    <input type="tel" id="custPhone" placeholder="Phone Number">
    <input type="text" id="custAadhaar" placeholder="Aadhaar Number (12 digits)" maxlength="12" required>
    <textarea id="custAddress" rows="2" placeholder="Pickup Address"></textarea>
    <input type="number" id="duration" placeholder="Rental Days" min="1">

    <div style="margin:10px 0;padding:10px;border:1px dashed var(--border);border-radius:10px">
      <b>Payment Method</b><br>
      <span style="opacity:.85">üíµ Cash on Delivery (COD)</span>
    </div>

    <label style="font-size:14px">
      <input type="checkbox" id="terms">
      I agree to the 
      <span style="color:var(--primary)">Terms & Conditions</span>
    </label>

    <ul style="font-size:12px;opacity:.75;margin-top:6px">
        <li>Valid ID proof is mandatory</li>
        <li>Late returns may incur extra charges</li>
        <li>Damage costs must be paid by customer</li>
        <li>Owner can cancel if item unavailable</li>
      </ul>

    <!-- Actions -->
    <div style="display:flex;gap:10px;margin-top:15px">
      <button id="confirmBtn" class="primary" disabled style="flex:1">
        Confirm Booking
      </button>
      <button class="danger" onclick="closeBooking()" style="flex:1">
        Cancel
      </button>
  </div>
</div>
</div>

<script>
const customerId = localStorage.getItem("customer_id");
if(!customerId){
  alert("Login required");
  location.href="index.html";
}

document.getElementById("customerName").innerText =
  localStorage.getItem("name") || "Customer";

function logout(){
  localStorage.clear();
  location.href="index.html";
}

const locationSelect = document.getElementById("location");
const items = document.getElementById("items");
const history = document.getElementById("history");

let selectedItem = null;
const bookingModal = document.getElementById("bookingModal");
const confirmBtn = document.getElementById("confirmBtn");

const custName = document.getElementById("custName");
const custPhone = document.getElementById("custPhone");
const custAddress = document.getElementById("custAddress");
const duration = document.getElementById("duration");
const terms = document.getElementById("terms");

[custName,custPhone,custAddress,duration,terms].forEach(el=>{
  el.oninput = validateForm;
});

function validateForm(){
  confirmBtn.disabled = !(
    custName.value.trim() &&
    custPhone.value.trim().length >= 10 &&
    custAddress.value.trim() &&
    duration.value > 0 &&
    terms.checked
  );
}

function openBooking(id){
  selectedItem = id;
  bookingModal.style.display="flex";
  custName.value="";
  custPhone.value="";
  custAddress.value="";
  duration.value="";
  terms.checked=false;
  confirmBtn.disabled=true;
}

function closeBooking(){
  bookingModal.style.display="none";
}

confirmBtn.onclick = async ()=>{
  try{
    const res = await fetch("/api/create-request",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        action:"createBooking",
        item_id:selectedItem,
        customer_id:customerId,
        name:custName.value,
        phone:custPhone.value,
        address:custAddress.value,
        rental_duration:duration.value,
        payment_method:"COD"
      })
    });
    const d = await res.json();
    if(d.success){
      alert("‚úÖ Booking placed successfully");
      closeBooking();
      loadHistory();
    } else alert(d.message || "Failed");
  } catch {
    alert("Server error");
  }
};

async function loadLocations(){
  const res = await fetch("/api/items");
  const d = await res.json();
  locationSelect.innerHTML=`<option value="">Select location</option>`;
  d.locations.forEach(l=>{
    locationSelect.innerHTML+=`<option>${l}</option>`;
  });
}

async function loadItems(category){
  if(!locationSelect.value){ alert("Select location"); return; }
  items.innerHTML="Loading...";
  const res = await fetch("/api/items",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"getItems",category,location:locationSelect.value})
  });
  const d = await res.json();
  items.innerHTML="";
  d.items.forEach(i=>{
    items.innerHTML+=`
      <div class="card">
        <h4>${i.item_name}</h4>
        <p>‚Çπ${i.price_per_day}/day</p>
        <p>${i.shop_name}</p>
        <button class="primary" onclick="openBooking(${i.item_id})">Book Now</button>
      </div>`;
  });
}

async function loadHistory(){
  const res = await fetch(`/api/create-request?customer_id=${customerId}`);
  const d = await res.json();
  history.innerHTML="";
  d.history.forEach(b=>{
    history.innerHTML+=`
      <div class="card">
        <b>${b.item_name}</b><br>
        ${b.shop_name}<br>
        Days: ${b.rental_duration}<br>
        Status: <span class="${b.status}">${b.status}</span>
      </div>`;
  });
}

window.onload=()=>{
  loadLocations();
  loadHistory();
};
</script>

</body>
</html>
