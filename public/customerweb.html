<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Customer Dashboard | RentHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --panel:#0f172a;
  --card:rgba(255,255,255,0.06);
  --border:rgba(255,255,255,0.15);
  --primary:#38bdf8;
  --success:#22c55e;
  --danger:#ef4444;
  --pending:#facc15;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:Poppins,sans-serif;
  background:var(--bg);
  color:#fff;
  min-height:100vh;
  display:flex;
}

/* ===== SIDEBAR ===== */
aside{
  width:240px;
  background:var(--panel);
  padding:25px;
  display:flex;
  flex-direction:column;
  gap:18px;
}
aside button{
  margin-top:auto;
  padding:10px;
  border:none;
  border-radius:12px;
  background:var(--danger);
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

/* ===== MAIN ===== */
main{flex:1;padding:25px}
.section{margin-bottom:30px}

.location-select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:none;
  background:#020617;
  color:#fff;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:15px;
}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:16px;
  text-align:center;
}

.card.inactive{
  opacity:0.55;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
}

.primary{background:var(--primary);color:#000}
button:disabled{background:#777;cursor:not-allowed}

/* ===== MODAL ===== */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
}
.modal-content{
  background:var(--panel);
  padding:25px;
  border-radius:18px;
  width:90%;
  max-width:420px;
}
.modal-content input,
.modal-content textarea{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:10px;
  border:none;
  background:#020617;
  color:#fff;
}
</style>
</head>

<body>

<aside>
  <h2>üöÄ RentHub</h2>
  <p>Customer Panel</p>
  <b id="customerName"></b>
  <button onclick="logout()">Logout</button>
</aside>

<main>

<div class="section">
  <h3>Select Location</h3>
  <select id="location" class="location-select"></select>
</div>

<div class="section">
  <h3>Select Category</h3>
  <div class="grid">
    <div class="card" onclick="loadItems('Electronics')">üíª Electronics</div>
    <div class="card" onclick="loadItems('Bike')">üèç Bikes</div>
    <div class="card" onclick="loadItems('Car')">üöó Cars</div>
    <div class="card" onclick="loadItems('Tent')">üèï Tents</div>
    <div class="card" onclick="loadItems('Appliance')">üè† Appliances</div>
  </div>
</div>

<div class="section">
  <h3>Available Items</h3>
  <div class="grid" id="items"></div>
</div>

</main>

<!-- BOOKING MODAL -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <h3>Complete Booking</h3>
    <input id="custName" placeholder="Full Name">
    <input id="custPhone" placeholder="Phone">
    <input id="custAadhaar" placeholder="Aadhaar (12 digits)" maxlength="12">
    <textarea id="custAddress" placeholder="Pickup Address"></textarea>
    <input id="duration" type="number" placeholder="Days">
    <button id="confirmBtn" class="primary" disabled>Confirm</button>
    <button onclick="closeBooking()">Cancel</button>
  </div>
</div>

<script>
const customerId = localStorage.getItem("customer_id");
if(!customerId) location.href="index.html";

customerName.innerText = localStorage.getItem("name") || "Customer";

function logout(){
  localStorage.clear();
  location.href="index.html";
}

const itemsDiv = document.getElementById("items");
const locationSelect = document.getElementById("location");
let selectedItem = null;

/* ===== LOAD LOCATIONS ===== */
async function loadLocations(){
  const res = await fetch("/api/items");
  const d = await res.json();
  locationSelect.innerHTML = `<option value="">Select location</option>`;
  d.locations.forEach(l=>{
    locationSelect.innerHTML += `<option value="${l}">${l}</option>`;
  });
}

/* ===== LOAD ITEMS ===== */
async function loadItems(category){
  if(!locationSelect.value){ alert("Select location"); return; }

  itemsDiv.innerHTML = "Loading...";
  const res = await fetch("/api/items",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"getItems",
      category,
      location:locationSelect.value
    })
  });

  const d = await res.json();
  itemsDiv.innerHTML = "";

  if(!d.items || d.items.length === 0){
    itemsDiv.innerHTML = `<p>No items found</p>`;
    return;
  }

  d.items.forEach(i=>{
    const inactive = i.is_active == 0;

    itemsDiv.innerHTML += `
      <div class="card ${inactive?'inactive':''}">
        <h4>${i.item_name}</h4>
        <p>‚Çπ${i.price_per_day}/day</p>
        <p>${i.shop_name}</p>
        ${inactive ? '<b style="color:red">Unavailable</b>' : ''}
        <button class="primary"
          ${inactive?'disabled':''}
          onclick="${inactive?'':'openBooking('+i.item_id+')'}">
          Book Now
        </button>
      </div>
    `;
  });
}

/* ===== BOOKING ===== */
function openBooking(id){
  selectedItem = id;
  bookingModal.style.display="flex";
}
function closeBooking(){
  bookingModal.style.display="none";
}

confirmBtn.onclick = async ()=>{
  await fetch("/api/create-request",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"createBooking",
      item_id:selectedItem,
      customer_id:customerId,
      name:custName.value,
      phone:custPhone.value,
      address:custAddress.value,
      aadhaar:custAadhaar.value,
      rental_duration:duration.value
    })
  });
  alert("Booking placed");
  closeBooking();
};

loadLocations();
</script>
</body>
</html>
